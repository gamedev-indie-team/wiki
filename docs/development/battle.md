# Процесс битвы {docsify-ignore}

Механика битвы в себе содержит 4 основные части:

-   battle - основные сущности битвы
-   preparation - подготовка сущностей
-   block - блокирование урона
-   damage - механика расчета и нанесения урона
-   dead - механика смерти

## Battle

-   урон
-   карта нанесения урона
-   _сопротивление | уязвимость_
-   _добавление / удаление_ флага "получен урон"
-   _добавление / удаление_ флага "сущность бьёт"

Также описано создание сущности попадания удара в триггер цели и _добавление / удаление_ флагов получения урона и того, что сущность бьёт

## Preparation

Механика подготовки сущностей основана на двух системах:

1. смотрит наличие какой-либо характеристики, которой можно нанести урон
2. если после первой системы остались сущности, то собираем урон по характеристикам, которые есть у сущности цели и создаём новую сущность с подготовленным уроном

## Block

-   `AllowBlockTagComponent` - сущность может ставить блок (настройка сущности)
-   `BlockTagComponent` - состояние блокирования
-   `EventChangeBlockTagComponent` - событие изменения состояния блока

### Механизм

1. через `IBattleEventEcsFactory.GetEventChangeBlockTagEntity` создается событие смены состояния блокирования
2. если на сущности есть `AllowBlockTagComponent` то сущность становится в состояние блокирования (ставится `BlockTagComponent`)
3. если сущность имеет состояние: **атака**, **смерть**, **возрождение**, **прыжок** (полет), то `AllowBlockTagComponent` **убирается**
4. при блокировании атакующий откидывается в противоположном направлении от своего просмотра, через `IPhysicsEventEcsFactory.GetEventAddForceEntity`

?> Всегда отражается 100% урона

## Damage

Механика урона выполняет разделение урона по характеристикам и вычисляет урон в зависимости от наличия критического удара и _сопротивления | уязвимости_, а также учитывает переодический урон

Урон - количество урона от `0` до `∞`.  
Фактор - множитель урона от `0` до `∞`.  
Шанс критического урона - вероятность с которой произойдет крит. урон и имеет значение от `0` до `1`.

1. переодический урон создаёт копию сущности подготовленного урона, который идёт по дальнейшим системам, оригинальная сущность с таймером, по истечении всех итераций и времени, будет удалена
2. система добавления крита увеличивает урон по формуле, если крит произошёл.  
   2. 1. формула по умолчанию `урон * (1 + фактор)`
3. урон разделяется по типам _урона | сопротивления_ и характеристикам, по которым наносится урон, далее создаётся сущность с перечисленными ранее параметрами и количеством _урона | сопротивления_  
   3. 1. формула по умолчанию `рассчитанный урон = урон * (0.5 - ( сопротивление - |сопротивление - 1| ) / 2)`
4. нанесение урона по характеристике, которая указана в сущности

## Dead

Механика смерти содержит в себе следующие системы

-   отключение симуляции умершего тела
-   разбрасывает предметы, если есть инвентарь
-   скрывает представление через некоторое время, после окончания анимации смерти
